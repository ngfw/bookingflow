name: Deploy on Tag

on:
  push:
    tags:
      - 'v*'  # triggers on tag pushes like v1.0, v2.3

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            set -e
            APP_DIR=/var/www/bookingflow.gm-sunshine.com
            cd "$APP_DIR" || exit 1

            # Use the tag passed from GitHub Actions
            TAG_NAME="${{ github.ref_name }}"
            echo "ðŸš€ Deploying tag: $TAG_NAME"

            # Fetch and checkout
            git fetch --all --tags --force
            git reset --hard
            git checkout -f "$TAG_NAME"

            # Composer
            composer install --no-dev --optimize-autoloader

            # NPM - Build frontend assets
            npm install
            npm run build

            # Laravel commands
            if [ -f "$APP_DIR/.env" ] && php artisan migrate:status >/dev/null 2>&1; then
                php artisan migrate --force
                php artisan config:clear
                php artisan cache:clear
                php artisan route:clear
                php artisan view:clear
                php artisan optimize
            else
                echo "âš ï¸ App not installed, run initial setup first"
            fi

            # Set final permissions
            sudo chown -R www-data:www-data "$APP_DIR"
            sudo find "$APP_DIR" -type f -exec chmod 664 {} \;
            sudo find "$APP_DIR" -type d -exec chmod 775 {} \;
            # Restore execute permissions for node binaries
            sudo chmod +x "$APP_DIR"/node_modules/.bin/* 2>/dev/null || true
            sudo chgrp -R www-data "$APP_DIR"/storage "$APP_DIR"/bootstrap/cache
            sudo chmod -R ug+rwx "$APP_DIR"/storage "$APP_DIR"/bootstrap/cache

            # Reload PHP-FPM
            sudo systemctl reload php8.3-fpm || echo "PHP-FPM reload skipped"

            echo "âœ… Deployment of tag '$TAG_NAME' completed at $(date)"
