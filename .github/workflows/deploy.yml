name: Deploy to Production

on:
  push:
    tags:
      - 'v*'  # triggers on tag pushes like v1.0, v2.3
  workflow_dispatch:  # Allow manual triggering
    inputs:
      skip_tests:
        description: 'Skip tests'
        required: false
        default: 'false'

jobs:
  # ============================================================================
  # Pre-deployment Checks
  # ============================================================================
  pre-deployment:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, zip
          coverage: none

      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-interaction --no-progress

      - name: Run syntax check
        run: |
          find app -name "*.php" -exec php -l {} \; | grep -v "No syntax errors"
          echo "‚úÖ PHP syntax check passed"

      - name: Check environment example file
        run: |
          if [ ! -f .env.production.example ]; then
            echo "‚ùå .env.production.example not found"
            exit 1
          fi
          echo "‚úÖ Environment example file exists"

  # ============================================================================
  # Deployment to Production
  # ============================================================================
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    needs: pre-deployment
    environment:
      name: production
      url: https://bookingflow.gm-sunshine.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Pre-deployment Health Check
        uses: appleboy/ssh-action@v1.2.0
        continue-on-error: true
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            # Check if health endpoint is responding
            curl -f https://bookingflow.gm-sunshine.com/health || echo "‚ö†Ô∏è Health check failed, proceeding with deployment"

      - name: Create Backup Before Deployment
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            set -e
            APP_DIR=/var/www/bookingflow.gm-sunshine.com
            BACKUP_DIR=/var/backups/bookingflow/pre-deployment
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)

            echo "üì¶ Creating pre-deployment backup..."
            mkdir -p "$BACKUP_DIR"

            # Backup database
            if [ -f "$APP_DIR/.env" ]; then
              cd "$APP_DIR"
              php artisan db:backup --backup-dir="$BACKUP_DIR" || echo "‚ö†Ô∏è Database backup failed"
            fi

            # Backup .env file
            cp "$APP_DIR/.env" "$BACKUP_DIR/.env.backup.$TIMESTAMP" || echo "‚ö†Ô∏è .env backup skipped"

            echo "‚úÖ Pre-deployment backup completed"

      - name: Deploy Application
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            set -e
            APP_DIR=/var/www/bookingflow.gm-sunshine.com
            cd "$APP_DIR" || exit 1

            # Use the tag passed from GitHub Actions
            TAG_NAME="${{ github.ref_name }}"
            echo "üöÄ Deploying tag: $TAG_NAME"

            # Enable maintenance mode
            php artisan down --retry=60 --secret="${{ secrets.MAINTENANCE_SECRET }}" || echo "‚ö†Ô∏è Maintenance mode failed"

            # Fetch and checkout
            git fetch --all --tags --force
            git reset --hard
            git checkout -f "$TAG_NAME"

            # Composer - Install PHP dependencies
            echo "üì¶ Installing Composer dependencies..."
            composer install --no-dev --optimize-autoloader --no-interaction

            # NPM - Build frontend assets
            echo "üé® Building frontend assets..."
            npm ci --only=production
            npm run build

            # Laravel Optimization
            echo "‚öôÔ∏è Running Laravel optimizations..."
            if [ -f "$APP_DIR/.env" ]; then
                # Clear all caches first
                php artisan config:clear
                php artisan cache:clear
                php artisan route:clear
                php artisan view:clear
                php artisan event:clear

                # Run migrations
                php artisan migrate --force

                # Optimize application
                php artisan config:cache
                php artisan route:cache
                php artisan view:cache
                php artisan event:cache
                php artisan optimize

                # Restart queue workers
                php artisan queue:restart
            else
                echo "‚ö†Ô∏è .env file not found, skipping Laravel commands"
            fi

            # Set proper permissions
            echo "üîí Setting permissions..."
            sudo chown -R www-data:www-data "$APP_DIR"
            sudo find "$APP_DIR" -type f -exec chmod 664 {} \;
            sudo find "$APP_DIR" -type d -exec chmod 775 {} \;
            sudo chmod +x "$APP_DIR"/node_modules/.bin/* 2>/dev/null || true
            sudo chgrp -R www-data "$APP_DIR"/storage "$APP_DIR"/bootstrap/cache
            sudo chmod -R ug+rwx "$APP_DIR"/storage "$APP_DIR"/bootstrap/cache

            # Reload services
            echo "üîÑ Reloading services..."
            sudo systemctl reload php8.3-fpm || echo "‚ö†Ô∏è PHP-FPM reload skipped"
            sudo systemctl reload nginx || echo "‚ö†Ô∏è Nginx reload skipped"

            # Disable maintenance mode
            php artisan up || echo "‚ö†Ô∏è Failed to disable maintenance mode"

            echo "‚úÖ Deployment of tag '$TAG_NAME' completed at $(date)"

      - name: Post-deployment Health Check
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            echo "üè• Running post-deployment health checks..."

            # Wait for application to be ready
            sleep 10

            # Check health endpoint
            HEALTH_CHECK=$(curl -s -o /dev/null -w "%{http_code}" https://bookingflow.gm-sunshine.com/health)

            if [ "$HEALTH_CHECK" = "200" ]; then
              echo "‚úÖ Health check passed (HTTP $HEALTH_CHECK)"
            else
              echo "‚ùå Health check failed (HTTP $HEALTH_CHECK)"
              exit 1
            fi

            # Check database connectivity
            cd /var/www/bookingflow.gm-sunshine.com
            php artisan migrate:status || echo "‚ö†Ô∏è Migration status check failed"

      - name: Run Smoke Tests
        uses: appleboy/ssh-action@v1.2.0
        continue-on-error: true
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            echo "üß™ Running smoke tests..."

            # Test homepage
            curl -f https://bookingflow.gm-sunshine.com/ || echo "‚ö†Ô∏è Homepage check failed"

            # Test API health
            curl -f https://bookingflow.gm-sunshine.com/ping || echo "‚ö†Ô∏è Ping check failed"

            echo "‚úÖ Smoke tests completed"

      # ============================================================================
      # Notifications
      # ============================================================================
      - name: Send Slack Notification (Success)
        if: success()
        uses: slackapi/slack-github-action@v1.25.0
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "‚úÖ Deployment Successful",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚úÖ BookingFlow Deployment Successful"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Version:*\n${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\nProduction"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Deployed by:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Time:*\n$(date)"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<https://bookingflow.gm-sunshine.com|View Application> | <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Deployment>"
                  }
                }
              ]
            }

      - name: Send Slack Notification (Failure)
        if: failure()
        uses: slackapi/slack-github-action@v1.25.0
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "‚ùå Deployment Failed",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚ùå BookingFlow Deployment Failed"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Version:*\n${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\nProduction"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Failed by:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Time:*\n$(date)"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "‚ö†Ô∏è Please check logs and rollback if necessary.\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Failed Deployment>"
                  }
                }
              ]
            }
